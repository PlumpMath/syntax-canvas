<!doctype html>
<html>
<head>
  <title>Language Canvas</title>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/theme/ambiance.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <style type="text/css">
      html, body { height: 100%; }
      body { margin: 1em; }
      form {
        height: 47%;
        margin-bottom: 1em;
      }

      .code {
        height: 100%;
      }

      .CodeMirror,
      .CodeMirror-scroll {
        height: 100%;
      }
      .CodeMirror {
      }
    </style>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/flexible/flexible.js"></script>
    <script src="codemirror/mode/slymtax/slymtax.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>
    <script src="codemirror/mode/css/css.js"></script>

    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript">
      $('.nav a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
      });
    </script>
    <script type="text/javascript">
    $(function() {
      RegExp.prototype.toString = function() {
        if(typeof this.source == 'undefined')
          return "";
        else
          return this.source;
      }

      $(".tab-pane").each(function(i, tab) {
        var parser = CodeMirror.fromTextArea($(".parser", tab).get()[0], {
          theme:"ambiance",
          mode: "text/slymtax",
          smartIndent:false,
          onChange:function() {
            var Syntax = [];
            var syntaxLines = parser.getValue().split("\n");
            for (var i = syntaxLines.length - 1; i >= 0; i--) {
              try {
                var matches, token, styles;
                if(matches = /\/([^\/]+)\/\s*:\s*(.+)/.exec(syntaxLines[i])) {
                  // regexp rule
                  token = new RegExp("^" + matches[1].trim().replace(/ /g, "")); // whitespace replace, bad idea?
                  styles = matches[2].trim().split(" ");
                  
                } else if(matches = /'([^']+)'\s*:\s*(.+)/.exec(syntaxLines[i])) {
                  // string rule
                  token = matches[1].trim();
                  styles = matches[2].trim().split(" ");

                } else {
                  continue;

                }
                
                if(typeof styles != "undefined" && typeof token != "undefined") Syntax.push([token, styles]);

              } catch(e) {}
            }

            parser.syntax = Syntax;
            editor.setOption("mode", editor.getOption("mode")) // refresh editor
          }
        });
        parser.syntax = [];

        console.log(parser);

        var editor = CodeMirror.fromTextArea($(".code", tab).get()[0], {
          theme:"ambiance",
          mode: {
            name: "flexible",
            parser: parser
          },
          lineNumbers: true,
          onHighlightComplete:function() {
            localStorage.setItem("parserText", parser.getValue());
            localStorage.setItem("editorText", editor.getValue());
          }
        });


        // editor.setValue(localStorage.getItem("editorText"));
        // parser.setValue(localStorage.getItem("parserText"));

          editor.setValue("# Ramsey Nasser's Language Canvas\n# \n# type your code here, and your syntax in the lower pane\n# syntax syntax is MATCH : STYLE, STYLE... where MATCH is\n# a single quoted string, a simple regex or a regex with\n# captures and STYLE is an unquoted style name, indicating\n# how to style the text. Custom styling coming soon. \n# \n# styles are: keyword, atom, number, def, variable, variable-2\n# variable-3, property, operator, comment, string, string-2\n# meta, error, qualifier, builtin, bracket, tag, attribute\n# header, quote, hr, link  \n\nself.range = (10...32)");
          parser.setValue("/\\((\\d+)(...)(\\d+)\\)/ : number operator number\n/#.*/ : comment\n'self' : builtin")

          editor.setOption("mode", editor.getOption("mode")); // refresh editor
        });

    });
</script>
</head>
<body>
  <ul class="nav nav-tabs">
    <li><a href="#tab1" data-toggle="tab">Quack</a></li>
    <li class="active"><a href="#tab2" data-toggle="tab">Snipe</a></li>
    <li><a href="#tab3" data-toggle="tab">Zajal</a></li>
    <li class="pull-right"><button class="btn btn-primary"><i class="icon-plus icon-white"></i></button></li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane" id="tab1">
      <form><textarea class="code"></textarea></form>
      <form><textarea class="parser a"></textarea></form>
    </div>
    <div class="tab-pane active" id="tab2">
      <form><textarea class="code"></textarea></form>
      <form><textarea class="parser b"></textarea></form>
    </div>
    <div class="tab-pane" id="tab3">
      <form><textarea class="code"></textarea></form>
      <form><textarea class="parser c"></textarea></form>
    </div>
  </div>
</body>
</html>