<!doctype html>
<html>
<head>
	<title>Language Canvas</title>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/theme/ambiance.css">
    <style type="text/css">
	    html, body { height: 100%; }
	    body { margin: 1em; }
	    form {
	    	height: 47%;
	    	margin-bottom: 1em;
	    }

	    .CodeMirror,
	    .CodeMirror-scroll {
	    	height: 100%;
	    }
	    .CodeMirror {
	    }
    </style>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/flexible/flexible.js"></script>
    <script src="codemirror/mode/slymtax/slymtax.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>
    <script src="codemirror/mode/css/css.js"></script>
</head>
<body>
	<form><textarea id="code"></textarea></form>
	<form><textarea id="parser"></textarea></form>
</body>
<script>
RegExp.prototype.toString = function() {
	if(typeof this.source == 'undefined')
		return "";
	else
		return this.source;
}

var Syntax = [];

var parser = CodeMirror.fromTextArea(document.getElementById("parser"), {
	theme:"ambiance",
	mode:"text/slymtax",
	smartIndent:false,
	onChange:function() {
		Syntax = [];
		var syntaxLines = parser.getValue().split("\n");
		for (var i = syntaxLines.length - 1; i >= 0; i--) {
			try {
				var matches, token, styles;
				if(matches = /\/([^\/]+)\/\s*:\s*(.+)/.exec(syntaxLines[i])) {
					// regexp rule
					token = new RegExp("^" + matches[1].trim().replace(/ /g, "")); // whitespace replace, bad idea?
					styles = matches[2].trim().split(" ");
					
				} else if(matches = /'([^']+)'\s*:\s*(.+)/.exec(syntaxLines[i])) {
					// string rule
					token = matches[1].trim();
					styles = matches[2].trim().split(" ");

				} else {
					continue;

				}
				
				if(typeof styles != "undefined" && typeof token != "undefined") Syntax.push([token, styles]);

			} catch(e) {}
		}

		editor.setOption("mode", editor.getOption("mode"));
	}
});

var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
	theme:"ambiance",
	mode:"text/flexible",
	lineNumbers: true,
	onHighlightComplete:function() {
		localStorage.setItem("parserText", parser.getValue());
		localStorage.setItem("editorText", editor.getValue());
	}
});

document.body.onload = function() {
	editor.setValue(localStorage.getItem("editorText"));
	parser.setValue(localStorage.getItem("parserText"));

	if(editor.getValue() == "" && parser.getValue() == "") {
		editor.setValue("# Ramsey Nasser's Language Canvas\n# \n# type your code here, and your syntax in the lower pane\n# syntax syntax is MATCH : STYLE, STYLE... where MATCH is\n# a single quoted string, a simple regex or a regex with\n# captures and STYLE is an unquoted style name, indicating\n# how to style the text. Custom styling coming soon. \n# \n# styles are: keyword, atom, number, def, variable, variable-2\n# variable-3, property, operator, comment, string, string-2\n# meta, error, qualifier, builtin, bracket, tag, attribute\n# header, quote, hr, link  \n\nself.range = (10...32)");
		parser.setValue("/\\((\\d+)(...)(\\d+)\\)/ : number operator number\n/#.*/ : comment\n'self' : builtin")
	}

	editor.setOption("mode", editor.getOption("mode"));
};

</script>
</html>